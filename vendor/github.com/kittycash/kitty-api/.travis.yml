sudo: required

services:
- docker

env:
  global:
  - REGISTRY_USER=kittycashrobot
  - secure: VJiVnOtZpRMkK1t0r1Fm5b1lzaOzMGdY9QEZtPP/gSiUCl4AKZMuNmZsJDM1K7iMsBLS2yYUFiSfOvzIbCH6Ma1bRu63zLxoafRSIxDa3k5jf1pif2zJnnat7EWW04BWEfsj7srteCveckfpd19JPtRsDJK2hBSPRM+8EvMKWpdimeHsIdCRo3YAtjg08nzCHC0aZuwl91fky+gx+yUhKjI++7kW3lVZkBbwtJ9dIzhVk2UEqirVUWWIWXAlTLwlwi2qIrU4Thvo68rf5IUsMaOn8Wz3chL6aYNnI8OXVGtbTNbJjyVFZNeWtTqBRfzBAXrtzVyxcz1ZP+isnRVMJPKeqWYUHZ5G73+jO953cDYo63cUMdKVapITM6CMwQNzlrI3THc4KqIF5vX5CcI0HZ1lbVWb1fOarPTd00CoZ4XI/zphpV97dEuH0Rg9ZrfLamMAueDeTLJQn1QGtv65lhD/JzcIiZK6poLyMLAQT9otCEc9farcSGopOFF3AjttlASrfMAxe4ir8eYBAlkyiIGtvF8y3iW8MthVvMFFLlQdbJT5TgUPGa3frBXFWdVSIB6Uau4aBZjQBJfqJOMj3lGFTqnOKmaTKJVZo3G524lzyCTO19QrSBVTgrEC+7fOzJ4GTezaYI2YTZj+e6hxfz3YS2SD82ua9PLTNTwZyV0=

before_script:
- docker pull kittycash/kitty-api || true

script:
- "./docker-build.sh"
- docker run $(./docker-tags.sh | head -n 1) test

after_script:
- docker images

before_deploy:
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
  provider: script
  script: "./docker-deploy.sh"
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^develop|master$ || $(git tag --points-at HEAD) != ""
